# Snowflake Setup Guide for Mercurios.ai

This guide outlines the steps to set up Snowflake as a scalable, multi-tenant data warehouse for Mercurios.ai.

## 1. Snowflake Account Setup

1. Sign up for a Snowflake account at [Snowflake](https://signup.snowflake.com/)
   - Select AWS as the cloud provider
   - Choose the Frankfurt (eu-central-1) region for GDPR compliance
   - Start with Enterprise edition for row-level security features

2. Once your account is active, note down:
   - Account identifier (URL)
   - Admin username and password

## 2. Warehouse Configuration

Create separate warehouses for different workloads:

```sql
-- ETL/Loading warehouse (medium size, auto-suspend after 5 minutes)
CREATE WAREHOUSE IF NOT EXISTS MERCURIOS_LOADING_WH
  WITH WAREHOUSE_SIZE = 'MEDIUM'
  AUTO_SUSPEND = 300
  AUTO_RESUME = TRUE
  INITIALLY_SUSPENDED = TRUE;

-- Analytics warehouse (large size, auto-suspend after 10 minutes)
CREATE WAREHOUSE IF NOT EXISTS MERCURIOS_ANALYTICS_WH
  WITH WAREHOUSE_SIZE = 'LARGE'
  AUTO_SUSPEND = 600
  AUTO_RESUME = TRUE
  INITIALLY_SUSPENDED = TRUE;

-- Development warehouse (small size, auto-suspend after 2 minutes)
CREATE WAREHOUSE IF NOT EXISTS MERCURIOS_DEV_WH
  WITH WAREHOUSE_SIZE = 'SMALL'
  AUTO_SUSPEND = 120
  AUTO_RESUME = TRUE
  INITIALLY_SUSPENDED = TRUE;
```

## 3. Database and Schema Setup

Create a multi-tenant database structure:

```sql
-- Create main database
CREATE DATABASE IF NOT EXISTS MERCURIOS_DATA;

-- Create schemas
USE DATABASE MERCURIOS_DATA;

-- Raw data schema (landing zone for Fivetran)
CREATE SCHEMA IF NOT EXISTS RAW;

-- Standardized data schema (cleaned and conformed data)
CREATE SCHEMA IF NOT EXISTS STANDARD;

-- Analytics schema (metrics and aggregations)
CREATE SCHEMA IF NOT EXISTS ANALYTICS;

-- Tenant-specific schemas (for customer-specific customizations)
CREATE SCHEMA IF NOT EXISTS TENANT_CUSTOMIZATIONS;
```

## 4. Role-Based Access Control

Set up roles for different access patterns:

```sql
-- Create roles
CREATE ROLE IF NOT EXISTS MERCURIOS_ADMIN;
CREATE ROLE IF NOT EXISTS MERCURIOS_ANALYST;
CREATE ROLE IF NOT EXISTS MERCURIOS_DEVELOPER;
CREATE ROLE IF NOT EXISTS MERCURIOS_FIVETRAN_SERVICE;
CREATE ROLE IF NOT EXISTS MERCURIOS_APP_SERVICE;

-- Grant warehouse access
GRANT USAGE ON WAREHOUSE MERCURIOS_LOADING_WH TO ROLE MERCURIOS_FIVETRAN_SERVICE;
GRANT USAGE ON WAREHOUSE MERCURIOS_ANALYTICS_WH TO ROLE MERCURIOS_ANALYST;
GRANT USAGE ON WAREHOUSE MERCURIOS_ANALYTICS_WH TO ROLE MERCURIOS_APP_SERVICE;
GRANT USAGE ON WAREHOUSE MERCURIOS_DEV_WH TO ROLE MERCURIOS_DEVELOPER;
GRANT USAGE ON ALL WAREHOUSES TO ROLE MERCURIOS_ADMIN;

-- Grant database access
GRANT USAGE ON DATABASE MERCURIOS_DATA TO ROLE MERCURIOS_ADMIN;
GRANT USAGE ON DATABASE MERCURIOS_DATA TO ROLE MERCURIOS_ANALYST;
GRANT USAGE ON DATABASE MERCURIOS_DATA TO ROLE MERCURIOS_DEVELOPER;
GRANT USAGE ON DATABASE MERCURIOS_DATA TO ROLE MERCURIOS_FIVETRAN_SERVICE;
GRANT USAGE ON DATABASE MERCURIOS_DATA TO ROLE MERCURIOS_APP_SERVICE;

-- Grant schema access
GRANT USAGE ON SCHEMA MERCURIOS_DATA.RAW TO ROLE MERCURIOS_FIVETRAN_SERVICE;
GRANT USAGE ON SCHEMA MERCURIOS_DATA.RAW TO ROLE MERCURIOS_ADMIN;
GRANT USAGE ON SCHEMA MERCURIOS_DATA.RAW TO ROLE MERCURIOS_DEVELOPER;

GRANT USAGE ON SCHEMA MERCURIOS_DATA.STANDARD TO ROLE MERCURIOS_ADMIN;
GRANT USAGE ON SCHEMA MERCURIOS_DATA.STANDARD TO ROLE MERCURIOS_ANALYST;
GRANT USAGE ON SCHEMA MERCURIOS_DATA.STANDARD TO ROLE MERCURIOS_DEVELOPER;
GRANT USAGE ON SCHEMA MERCURIOS_DATA.STANDARD TO ROLE MERCURIOS_APP_SERVICE;

GRANT USAGE ON SCHEMA MERCURIOS_DATA.ANALYTICS TO ROLE MERCURIOS_ADMIN;
GRANT USAGE ON SCHEMA MERCURIOS_DATA.ANALYTICS TO ROLE MERCURIOS_ANALYST;
GRANT USAGE ON SCHEMA MERCURIOS_DATA.ANALYTICS TO ROLE MERCURIOS_APP_SERVICE;
GRANT USAGE ON SCHEMA MERCURIOS_DATA.ANALYTICS TO ROLE MERCURIOS_DEVELOPER;

GRANT USAGE ON SCHEMA MERCURIOS_DATA.TENANT_CUSTOMIZATIONS TO ROLE MERCURIOS_ADMIN;
GRANT USAGE ON SCHEMA MERCURIOS_DATA.TENANT_CUSTOMIZATIONS TO ROLE MERCURIOS_DEVELOPER;

-- Grant object access
GRANT ALL ON ALL TABLES IN SCHEMA MERCURIOS_DATA.RAW TO ROLE MERCURIOS_FIVETRAN_SERVICE;
GRANT SELECT ON ALL TABLES IN SCHEMA MERCURIOS_DATA.RAW TO ROLE MERCURIOS_DEVELOPER;
GRANT SELECT ON ALL TABLES IN SCHEMA MERCURIOS_DATA.RAW TO ROLE MERCURIOS_ADMIN;

GRANT SELECT ON ALL TABLES IN SCHEMA MERCURIOS_DATA.STANDARD TO ROLE MERCURIOS_ANALYST;
GRANT SELECT ON ALL TABLES IN SCHEMA MERCURIOS_DATA.STANDARD TO ROLE MERCURIOS_APP_SERVICE;
GRANT ALL ON ALL TABLES IN SCHEMA MERCURIOS_DATA.STANDARD TO ROLE MERCURIOS_DEVELOPER;
GRANT ALL ON ALL TABLES IN SCHEMA MERCURIOS_DATA.STANDARD TO ROLE MERCURIOS_ADMIN;

GRANT SELECT ON ALL TABLES IN SCHEMA MERCURIOS_DATA.ANALYTICS TO ROLE MERCURIOS_ANALYST;
GRANT SELECT ON ALL TABLES IN SCHEMA MERCURIOS_DATA.ANALYTICS TO ROLE MERCURIOS_APP_SERVICE;
GRANT ALL ON ALL TABLES IN SCHEMA MERCURIOS_DATA.ANALYTICS TO ROLE MERCURIOS_DEVELOPER;
GRANT ALL ON ALL TABLES IN SCHEMA MERCURIOS_DATA.ANALYTICS TO ROLE MERCURIOS_ADMIN;

-- Create a service user for Fivetran
CREATE USER IF NOT EXISTS FIVETRAN_SERVICE
  PASSWORD = 'REPLACE_WITH_SECURE_PASSWORD'
  DEFAULT_ROLE = MERCURIOS_FIVETRAN_SERVICE
  DEFAULT_WAREHOUSE = MERCURIOS_LOADING_WH;

GRANT ROLE MERCURIOS_FIVETRAN_SERVICE TO USER FIVETRAN_SERVICE;

-- Create a service user for your application
CREATE USER IF NOT EXISTS APP_SERVICE
  PASSWORD = 'REPLACE_WITH_SECURE_PASSWORD'
  DEFAULT_ROLE = MERCURIOS_APP_SERVICE
  DEFAULT_WAREHOUSE = MERCURIOS_ANALYTICS_WH;

GRANT ROLE MERCURIOS_APP_SERVICE TO USER APP_SERVICE;
```

## 5. Multi-Tenant Table Design

Create tables with tenant isolation:

```sql
-- Example of a multi-tenant table design
CREATE OR REPLACE TABLE MERCURIOS_DATA.STANDARD.ARTICLES (
    TENANT_ID VARCHAR NOT NULL,
    ARTICLE_ID VARCHAR NOT NULL,
    ARTICLE_NUMBER VARCHAR,
    NAME VARCHAR,
    DESCRIPTION VARCHAR,
    CATEGORY VARCHAR,
    BRAND VARCHAR,
    SUPPLIER VARCHAR,
    PURCHASE_PRICE FLOAT,
    SELLING_PRICE FLOAT,
    PROFIT_MARGIN FLOAT,
    STOCK_QUANTITY INTEGER,
    STOCK_STATUS VARCHAR,
    CREATED_AT TIMESTAMP_NTZ,
    UPDATED_AT TIMESTAMP_NTZ,
    PRIMARY KEY (TENANT_ID, ARTICLE_ID)
);

-- Row-level security policy for tenant isolation
CREATE OR REPLACE ROW ACCESS POLICY TENANT_ISOLATION_POLICY ON MERCURIOS_DATA.STANDARD.ARTICLES
    AS (TENANT_ID VARCHAR) RETURNS BOOLEAN ->
    CURRENT_ROLE() IN ('MERCURIOS_ADMIN', 'MERCURIOS_DEVELOPER') 
    OR EXISTS (
        SELECT 1 FROM MERCURIOS_DATA.STANDARD.TENANT_ACCESS
        WHERE USER_ROLE = CURRENT_ROLE()
        AND TENANT_ID = ARTICLES.TENANT_ID
    );

-- Apply the policy
ALTER TABLE MERCURIOS_DATA.STANDARD.ARTICLES ADD ROW ACCESS POLICY TENANT_ISOLATION_POLICY;
```

## 6. Fivetran Connection Setup

1. In Fivetran, select "Connect your destination"
2. Choose "Snowflake" as the destination type
3. Enter the following details:
   - Account: Your Snowflake account identifier
   - Database: MERCURIOS_DATA
   - Schema: RAW
   - Username: FIVETRAN_SERVICE
   - Password: The password you created
   - Warehouse: MERCURIOS_LOADING_WH
   - Role: MERCURIOS_FIVETRAN_SERVICE

4. Test the connection
5. Once successful, complete the setup

## 7. Data Lifecycle Management

Set up data retention policies:

```sql
-- Create a stream to track changes
CREATE OR REPLACE STREAM MERCURIOS_DATA.RAW.ARTICLE_CHANGES ON TABLE MERCURIOS_DATA.RAW.ARTICLES;

-- Create a task to archive old data
CREATE OR REPLACE TASK MERCURIOS_DATA.RAW.ARCHIVE_OLD_DATA
  WAREHOUSE = MERCURIOS_LOADING_WH
  SCHEDULE = 'USING CRON 0 0 * * * UTC'
AS
  INSERT INTO MERCURIOS_DATA.RAW.ARTICLES_ARCHIVE
  SELECT * FROM MERCURIOS_DATA.RAW.ARTICLES
  WHERE UPDATED_AT < DATEADD(MONTH, -6, CURRENT_TIMESTAMP());
```

## 8. Performance Optimization

Configure clustering keys for better query performance:

```sql
-- Add clustering keys to improve query performance
ALTER TABLE MERCURIOS_DATA.STANDARD.ARTICLES CLUSTER BY (TENANT_ID, CATEGORY);
ALTER TABLE MERCURIOS_DATA.STANDARD.CUSTOMERS CLUSTER BY (TENANT_ID);
ALTER TABLE MERCURIOS_DATA.STANDARD.ORDERS CLUSTER BY (TENANT_ID, ORDER_DATE);
```

## Next Steps

After completing this setup:
1. Connect your Fivetran ProHandel connector to this Snowflake destination
2. Enhance your Lambda function to include tenant_id in all data
3. Set up dbt for transformations from RAW to STANDARD and ANALYTICS schemas
